---
import ListingLayout from '@/layouts/ListingLayout.astro';
import PropertyListingWithFilters from '@/components/vue/PropertyListingWithFilters.vue';
import { db, Properties, PropertiesImages, PropertyCategories, Categories, eq, sql } from 'astro:db';
import type { PropertiesWithImages } from '@/types';
import { resolveImage } from '@/lib/helpers/resolveImage';

// Query directa a Astro DB con JOIN para obtener imágenes y categorías agrupadas
const propertiesQuery = sql`
  SELECT 
    p.*,
    json_group_array(
      DISTINCT json_object('id', pi.id, 'image', pi.image, 'cloudinaryUrl', pi.cloudinaryUrl, 'propertyId', pi.propertyId)
    ) FILTER (WHERE pi.id IS NOT NULL) as images,
    json_group_array(
      DISTINCT json_object(
        'id', c.id, 
        'name', c.name, 
        'slug', c.slug, 
        'icon', c.icon
      )
    ) FILTER (WHERE c.id IS NOT NULL) as categories
  FROM ${Properties} p
  LEFT JOIN ${PropertiesImages} pi ON p.id = pi.propertyId
  LEFT JOIN ${PropertyCategories} pc ON p.id = pc.propertyId
  LEFT JOIN ${Categories} c ON pc.categoryId = c.id
  WHERE p.isActive = 1
  GROUP BY p.id
  ORDER BY p.featured DESC, p.title ASC
`;

const { rows } = await db.run(propertiesQuery);

// Parsear y mapear datos
const listings = rows.map((row: any) => ({
  ...row,
  images: JSON.parse(row.images || '[]').map(resolveImage),
  categories: JSON.parse(row.categories || '[]'),
  featured: Boolean(row.featured),
  isActive: Boolean(row.isActive),
})) as PropertiesWithImages[];
---

<ListingLayout>
  <!-- Sistema de filtros Vue - Ahora incluye sidebar móvil + grid -->
  <PropertyListingWithFilters 
    client:load 
    properties={listings}
  />
</ListingLayout>
