---
import ListingLayout from '@/layouts/ListingLayout.astro';
import ListingCard from '@/components/astro/ListingCard.astro';
import { db, Properties, PropertiesImages, eq, sql } from 'astro:db';
import type { PropertiesWithImages } from '@/types';

// Query directa a Astro DB con JOIN para obtener imÃ¡genes agrupadas
const propertiesQuery = sql`
  SELECT 
    p.*,
    json_group_array(
      json_object(
        'id', pi.id,
        'image', pi.image
      )
    ) FILTER (WHERE pi.id IS NOT NULL) as images
  FROM ${Properties} p
  LEFT JOIN ${PropertiesImages} pi ON p.id = pi.propertyId
  WHERE p.isActive = 1
  GROUP BY p.id
  ORDER BY p.featured DESC, p.title ASC
`;

const { rows } = await db.run(propertiesQuery);

// Parsear y mapear datos
const listings = rows.map((row: any) => ({
  ...row,
  images: JSON.parse(row.images || '[]').map((img: any) => img.image),
  featured: Boolean(row.featured),
  isActive: Boolean(row.isActive),
})) as PropertiesWithImages[];
---

<ListingLayout>
  <div class="container mx-auto px-4 py-8">
    
    <!-- Header -->
    <header class="mb-8">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">
        Todas las Propiedades
      </h1>
      <p class="text-gray-600">
        {listings.length} propiedades disponibles
      </p>
    </header>

    <!-- Grid de propiedades -->
    <div class="w-full grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
      {listings.length > 0 ? (
        listings.map(item => (
          <ListingCard property={item} />
        ))
      ) : (
        <div class="col-span-full text-center py-12">
          <p class="text-gray-500 text-lg">
            No hay propiedades disponibles en este momento.
          </p>
        </div>
      )}
    </div>

  </div>
</ListingLayout>
